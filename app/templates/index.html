{% extends "base.html" %}
{% from "fragments/_macros.html" import render_modal_content, render_form_buttons %}

{% block content %}
<template id="create-waypoint-popup-template">
    <div class="create-waypoint-popup">
        <input type="text" class="create-waypoint-name-input" placeholder="Waypoint Name">
        <div class="popup-buttons">
            <button class="popup-button-edit" title="Edit Waypoint">
                <i class="fa-regular fa-edit"></i>
            </button>
            <button class="popup-button-delete" title="Delete Waypoint">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    </div>
</template>

<div class="top-right-controls">
    {% include "fragments/debug/menu_button.html" %}
    {% include "fragments/auth/widget.html" %}
    <button class="button about-button" onclick="document.querySelector('#modal-about').showModal()">
        <img src="static/images/favicon.ico">
    </button>
</div>

<aside>
    <h1>MotoTwist</h1>
    {% include "fragments/twists/creation_buttons.html" %}

    <form class="filter-form"
        hx-get="/twists/templates/list"
        hx-ext="morph"
        hx-target="#twist-list"
        hx-swap="morph:innerHTML"
        hx-trigger="change,
            keyup changed delay:500ms from:#twist-search-input,
            search from:#twist-search-input,
            mapCenterChange delay:500ms from:body,
            authChange from:body"
        hx-indicator="#search-indicator">

        <div class="search-container">
            <input id="twist-search-input" type="search" name="search" placeholder="Search">
            <span id="search-indicator" class="htmx-indicator">
                <i class="fa-solid fa-spinner fa-spin"></i>
            </span>
        </div>

        <details class="filter-dropdown">
            <summary>
                <span>
                    <i class="fa-solid fa-filter"></i> Filters
                </span>
                <i class="fa-solid fa-chevron-down chevron-icon"></i>
            </summary>

            <div class="filter-panel">
                <fieldset class="filter-fieldset">
                    <div class="filter-group" title="Filter Twists by ownership">
                        <input type="radio" id="own_all_twists" name="ownership" value="all" checked>
                        <label for="own_all_twists">All</label>
                        <input type="radio" id="own_own_twists" name="ownership" value="own">
                        <label for="own_own_twists">Mine</label>
                        <input type="radio" id="own_notown_twists" name="ownership" value="notown">
                        <label for="own_notown_twists">Not Mine</label>
                    </div>

                    <div class="filter-group" title="Filter Twists by pavement type">
                        <input type="radio" id="pavement_all_twists" name="pavement" value="all" checked>
                        <label for="pavement_all_twists">All</label>
                        <input type="radio" id="pavement_paved_twists" name="pavement" value="paved">
                        <label for="pavement_paved_twists">Paved</label>
                        <input type="radio" id="pavement_unpaved_twists" name="pavement" value="unpaved">
                        <label for="pavement_unpaved_twists">Unpaved</label>
                    </div>

                    <div class="filter-group" title="Filter Twists by rating status">
                        <input type="radio" id="ratings_all_twists" name="ratings" value="all" checked>
                        <label for="ratings_all_twists">All</label>
                        <input type="radio" id="ratings_rated_twists" name="ratings" value="rated">
                        <label for="ratings_rated_twists">Rated</label>
                        <input type="radio" id="ratings_unrated_twists" name="ratings" value="unrated">
                        <label for="ratings_unrated_twists">Unrated</label>
                    </div>

                    <div class="filter-group" title="Filter Twists by visibility on the map">
                        <input type="radio" id="vis_all_twists" name="visibility" value="all" checked>
                        <label for="vis_all_twists">All</label>
                        <input type="radio" id="vis_visible_twists" name="visibility" value="visible">
                        <label for="vis_visible_twists">Visible</label>
                        <input type="radio" id="vis_hidden_twists" name="visibility" value="hidden">
                        <label for="vis_hidden_twists">Hidden</label>
                    </div>
                </fieldset>
            </div>
        </details>
    </form>

    <ul id="twist-list" hx-get="/twists/templates/list" hx-trigger="load" hx-swap="innerHTML">
        <p>Loading Twists...</p>
    </ul>
</aside>

<div id="map"></div>

<dialog id="modal-login" class="modal">
    {% call render_modal_content("Login") %}
        <form class="modal-form" method="dialog"
            hx-post="/login"
            hx-target="#auth-widget"
            hx-swap="outerHTML">

            <div class="form-group">
                <label for="username">Email</label>
                <input type="email" id="username" name="username" required>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>

            {% if settings.ALLOW_USER_REGISTRATION %}
            <a href="/register" class="button button-very-small button-link">
                Don't have an account? Register!
            </a>
            {% else %}
            <span>Contact an administrator to create an account.</span>
            {% endif %}

            {{ render_form_buttons(submit_text="Login") }}
        </form>
    {% endcall %}
</dialog>

<dialog id="modal-about" class="modal">
    {% call render_modal_content("About") %}
    <div class="about-content">
        <p class="app-tagline">
            The ultimate companion for every motorcycle enthusiast. Discover, track, and save your most epic journeys.
        </p>

        <ul class="info-list">
            <li>
                <span>Current Version</span>
                <strong>{{ settings.MOTOTWIST_VERSION }}</strong>
            </li>
            <li>
                <span>Latest Version</span>
                <strong hx-get="/latest-version" hx-trigger="load" hx-swap="outerHTML">Unknown</strong>
            </li>
            <li>
                <span>Source Code</span>
                <a href="https://github.com/{{ settings.MOTOTWIST_UPSTREAM }}" target="_blank" class="button-link">View on GitHub</a>
            </li>
            {% if settings.DEBUG_MODE %}
            <li>
                <span>API Docs</span>
                <a href="/docs" target="_blank" class="button-link">View API Docs</a>
            </li>
            {% endif %}
        </ul>

        <div class="support-info">
            <p>Enjoying the app? A small contribution helps keep the project alive and running!</p>
            <a href='https://ko-fi.com/B0B11LJBPP' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi3.png?v=6' border='0' alt='Buy Me a Coffee at ko-fi.com' /></a>
        </div>
    </div>
    {% endcall %}
</dialog>

<dialog id="modal-profile" class="modal modal-dynamic"
    hx-get="/users/templates/profile-modal"
    hx-target="this"
    hx-trigger="updateProfileModal from:body"
    hx-swap="innerHTML">

    <p>Loading...</p>
</dialog>

<dialog id="modal-admin-settings" class="modal modal-dynamic">
    <p>Loading...</p>
</dialog>

<dialog id="modal-create-twist" class="modal">
    {% call render_modal_content("New Twist") %}
    <form class="modal-form manual-validation"
        hx-ext="json-enc"
        hx-post="/twists"
        hx-target="#twist-list"
        hx-swap="afterbegin">

        <div class="form-group">
            <label for="modal-name">Twist Name</label>
            <input type="text" id="modal-name" name="name" required>
        </div>

        <div class="form-group">
            <fieldset class="form-fieldset">
                <legend>Surface Type</legend>
                <div class="radio-group">
                    <label><input type="radio" name="is_paved" value="true" checked> Paved</label>
                    <label><input type="radio" name="is_paved" value="false"> Unpaved</label>
                </div>
            </fieldset>
        </div>

        <div id="route-status-indicator" class="gone"></div>

        {{ render_form_buttons(submit_text="Create Twist") }}
    </form>
    {% endcall %}
</dialog>

<dialog id="modal-rate-twist" class="modal modal-dynamic">
    <p>Loading...</p>
</dialog>

<dialog id="modal-view-twist-ratings" class="modal modal-dynamic">
    <p>Loading...</p>
</dialog>

<dialog id="modal-delete-twist" class="modal modal-dynamic">
    <p>Loading...</p>
</dialog>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"
        integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer">
    </script>

    <script type="module" src="static/js/main.js" defer></script>
{% endblock %}